# プライベート認証局を構築する
## 1.環境構築
```
cd ~
mkdir root-ca
cd root-ca
mkdir certs db private
chmod 700 private
touch db/index
openssl rand -hex 16 > db/serial
```
## 2. 認証局の証明書作成
### 2-1. 認証局の構築に必要な設定を定義した構成ファイルを作成する
```
vi root-ca.conf
```
```
name_opt = utf8,esc_ctrl,multiline,lname,align

[req]
default_bits = 4096
encrypt_key = no
default_md = sha256
utf8 = yes
string_mask = utf8only
prompt = no
distinguished_name = req_dn
req_extensions = req_ext

[req_dn]
countryName = "JP"
organizationName ="Hoge CA"
commonName = "Root CA"

[req_ext]
basicConstraints = critical,CA:true
keyUsage = critical,keyCertSign
subjectKeyIdentifier = hash

[ca]
default_ca = CA_default

[CA_default]
name = root-ca
home = .
database = $home/db/index
serial = $home/db/serial
certificate = $home/$name.crt
private_key = $home/private/$name.key
RANDFILE = $home/private/random
new_certs_dir = $home/certs
unique_subject = no
copy_extensions = none
default_days = 3650
default_md = sha256
policy = policy_match

[policy_match]
countryName = supplied
stateOrProvinceName = optional
organizationName = supplied
organizationalUnitName = optional
commonName = supplied
emailAddress = optional
```

### 2-2. 構成ファイルの解説
  - [req]　：　認証局の証明書への署名要求の作成時に参照される
  - [req_dn], [req_ext]　：　[req]の中で参照される
  - [ca]　 ：　認証局の証明書に自己署名するときに参照される
  - [CA_default]　：　[ca]から参照される
  - [policy_match]　：　[CA_default]から参照される


### 2-3. 認証局自身の証明書を作成
  秘密鍵（root-ca-secret.key）と署名要求（root-ca.csr）を作成する
  ```
  cd ~/root-ca  
  openssl req -new -config root-ca.conf -out root-ca.csr -keyout private/root-ca.key
  ```
  個の認証局はルート認証局扱いとなるため、自己署名により証明書（root-ca.crt）を作成する
  ```
  openssl ca -selfsign -config root-ca.conf -in root-ca.csr -out root-ca.crt -extensions req_ext
  ```

## 3. 署名用構成ファイルの作成
### 3-1. 認証局として、今後サーバー証明書に署名するために、必要な設定を定義した構成ファイルを用意する
  ```
  cd ~/root-ca
  vim sign-server.conf
  ```
  以下、構成ファイルの中身
  ```
  name_opt = utf8,esc_ctrl,multiline,lname,align
  
  [ca]
  default_ca = CA_default
  
  [CA_default]
  name = root-ca
  home = .
  database = $home/db/index
  serial = $home/db/serial
  certificate = $home/$name.crt
  private_key = $home/private/$name.key
  RANDFILE = $home/private/random
  new_certs_dir = $home/certs
  unique_subject = no
  copy_extensions = copy
  default_days = 365
  default_md = sha256
  policy = policy_match
  
  [policy_match]
  countryName = supplied
  stateOrProvinceName = optional
  organizationName = supplied
  organizationalUnitName = optional
  commonName = supplied
  emailAddress = optional
  
  [server_ext]
  authorityKeyIdentifier = keyid:always
  basicConstraints = critical,CA:false
  extendedKeyUsage = serverAuth
  keyUsage = critical,digitalSignature,keyEncipherment
  subjectKeyIdentifier = hash
  ```
### 3-2. 構成ファイルのポイント
  - [req]に関する項目はない
    ここでは署名のみを行うので、署名要求の作成に関する項目は不要となる
  - [CA-default]
    - copy_extension = copy
      署名要求の追加項目（subjectAltName）を証明書にコピーする
    - default_days = 365
      有効期限は１年間とする
  - [server_ext]を追加
    サーバー証明書に必要ないくつかの設定を定義
### 3-3. ルート証明書の受け取り（クライアントPC）
  クライアントPCで認証局からのルート証明書を受け取り、WEBブラウザが参照できるようにする  
  まず、認証局から証明書（root-ca.crt)を受け取る。
  ```
  scp <user>@<ca-server>:~/root-ca/root-ca.crt root-ca.crt
  ```
### 3-4. ルート証明書のWebブラウザへの読み込み (クライアントPC)
  ■ Windowsの場合
  タスクバーから証明書の管理コンソールを検索する
  ```
  certmgr.msc
  ```
  証明書をインポートする
  ```
  信頼されたルート証明機関 > 証明書 > すべてのタスク > インポート
  ```
## 4. サーバー証明書の作成（認証局）
  本来署名要求は、Webサーバー側で作成して、認証局に送付する形が一般的
  ここでは、認証局と同じサーバー上で、Webサーバーの秘密鍵や署名要求を作成することで簡略化する

  Webサーバーごとの証明書を作成するので、その格納ディレクトリを作成する
  ```
  cd ~
  mkdir web-server
  chmod 700 web-server
  ```

  まず、秘密鍵（web-server.key）を作成する
  ```
  cd ~/web-server
  openssl genpkey -out web-server.key -algorithm RSA -pkeyopt rsa_keygen_bits:2048
  ```

  次に、署名要求（web-server.csr）を作成する
  署名要求には、subjectAltNameを含める必要がある
  Webブラウザによっては、Common Nameではなく、subjectAltNameを参照するものがある
  ```
  openssl req -new -key web-server.key -out web-server.csr -addext "subjectAltName=DNS:example.com"
  ```

  ※DNSではなくIPアドレスを指定する場合は、以下のように記載する
  ```
  subjectAltName=IP:aaa.bbb.ccc.ddd
  ```

  以下の項目について質問されるので、順次回答していく
  ```
  Country Name (2 letter code) [AU]: JP
  State or Province Name (full name) [Some-State]: Tokyo
  Locality Name (e.g. city) []: Chiyoda
  Organization Name (eg. company) [Internet Widgits Pty Ltd]: Hoge LLC
  Organiztion Unit Name (eg. section) []: Home
  Common Name (e.g. server FQDN or YOUR name) []: example.com
  Email Address [];
  
  Please enter the following 'extra' attributes
  to be sent with your certificate request
  A challenge password []:
  An optional company name []:
  ```

## 5. プライベート認証局による署名
  Webサーバーの署名要求（web-server.csr）にプライベート認証局の秘密鍵で署名して、
  署名済証明書（web-server.crt）を作成する
  ```
  cd ~/root-ca
  openssl ca -config sign-server.conf \
  -in ../web-server/web-server.csr \
  -out ../web-server/web-server.crt \
  -extensions server_ext
  ```
  ⇒　署名済みの証明書が、~/web-server/web-server.crt として作成される

## 6. Webサーバーへの証明書の組み込み
  ■ 参考サイト
  ```
  https://pvision.jp/tech/2023/05/apache-how-to-enable-https/
  https://www.wakuwakubank.com/posts/612-web-server-ssl-server/
  ```

